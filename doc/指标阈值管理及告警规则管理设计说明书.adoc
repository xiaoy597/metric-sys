= 指标阈值管理及告警规则管理设计说明书 

== 指标阈值管理

=== 模块入口

指标数据管理（原指标查询分析） -> 指标阈值管理

=== 数据模型

* 指标数据阈值（metric_threshold）

[cols="1,2,4,1" options="header"]
|===
|字段名称|字段中文名称|字段描述|主键
|metric_threshold_id|指标数据阈值标识|自增的指标阈值唯一ID。|是
|metric_threshold_nm|指标数据阈值名称|指标阈值的中文名称。|否
|metric_cd|指标代码|阈值所属的指标代码。|否
|metric_granularity|数据粒度|通过维度+粒度的方式定义该阈值在指标数据集中的应用范围。例如阈值所属的指标具有日期维度和地区维度，如果数据粒度定义为“日期-月份”和“地区-区县”，则表示该阈值的检查范围仅限于该指标的区县月度指标数据。数据粒度采用JSON格式保存，具体格式为：{ "维度代码1": "维度字段代码1", "维度代码2": "维度字段代码2", ... "维度代码n", "维度字段代码n"}，如果数据粒度字段为空，则表示阈值应用于各维度的最细粒度。|否
|metric_drv_type|指标派生类型|定义阈值所应用的指标度量的类型。 +
0：指标原始值。 +
1：月度环比值。 +
2：季度环比值。 +
3：年度同比值。|否
|threshold_top_value|指标阈值上限|定义该阈值的上限。|否
|threshold_bottom_value|指标阈值下限|定义该阈值的下限。|否
|commiter|更新用户|最后更新该阈值的用户的ID。|否
|update_tm|更新时间|最后一次更新该阈值的时间。|否
|===

=== 功能列表

==== 显示指标阈值列表

===== 用户界面交互
. 用户在指标目录数中点选一个指标
. 系统显示在该指标上定义的指标阈值列表，阈值属性包括：
.. 阈值名称
.. 应用范围（显示为维度名称+粒度名称的列表），对应指标数据阈值表的数据粒度字段的内容。
.. 指标阈值上限
.. 指标阈值下限
. 用户可以对列表中的阈值条目进行编辑和删除。
. 用户点击列表上方的“新增”按钮可以为当前指标增加新的阈值。

===== 后台处理逻辑
. 查询当前用户可见的有效指标目录及指标列表。
. 根据用户选定的指标查询该指标的所有阈值记录。

==== 新增/编辑指标阈值

===== 用户界面交互
* 输入内容
. 指标阈值名称。指标阈值名称不得重复。
. 各维度的粒度。用户可以选择阈值所应用的各维度粒度，默认为最细粒度。
. 阈值上限值。可选，但上限和下限至少要指定一个。
. 阈值下限值。可选，但上限和下限至少要指定一个。


===== 后台处理逻辑
. 将页面提交的阈值定义保存到指标数据阈值表（metric_threshold）。
+ 
各指标数据阈值的名称不得重复。对于未指定的指标上限或下限值，对应字段填null。


==== 删除指标阈值

===== 用户界面交互
. 用户在阈值列表中点击需要删除的阈值定义条目右侧的“删除”按钮。
. 系统提示是否确认删除阈值定义。
. 用户点击“确定”，向后台提交阈值删除请求，否则返回列表。

===== 后台处理逻辑
. 根据页面提交的阈值删除请求从指标数据阈值表（metric_threshold）中删除对应记录。


== 告警规则管理

=== 模块入口

系统管理 -> 自动告警管理


=== 数据模型

* 系统事件类型（system_event_type）

[cols="1,2,4,1" options="header"]
|===
|字段名称|字段中文名称|字段描述|主键
|event_type_id|事件类型标识|自增的事件类型唯一ID。每一种需要处理的事件对应一个ID。|是
|event_category|事件类别|表示事件类型所属的类别。 +
0: 阈值越界事件|否
|event_type_nm|事件类型名称|事件类型的中文名称|否
|trigger_obj_id|触发对象ID|导致当前事件类型发生的对象。对于阈值越界事件，触发对象ID是发生越界的指标阈值ID。|否
|event_level|事件级别|事件的严重级别。 +
0：一般。 +
1：关注。 +
2：重要。 |否
|===

* 事件通知规则（event_notify_rule）

[cols="1,2,4,1" options="header"]
|===
|字段名称|字段中文名称|字段描述|主键
|event_type_id|事件类型标识|自增的事件类型唯一ID。每一种需要处理的事件对应一个ID。|是
|channel_id|渠道标识|表示当某类型的事件发生时，发送通知的渠道。|是
|template_id|内容模板标识|发送通知时所使用的内容模板。|否
|===

* 消息渠道（message_channel）

[cols="1,2,4,1" options="header"]
|===
|字段名称|字段中文名称|字段描述|主键
|channel_id|渠道标识|通知发送渠道的唯一标识。自增。|是
|channel_type|渠道类型|0：短信，1：邮件。|否
|channel_desc|渠道描述|保存渠道的具体内容，对于短信渠道，存放电话号码，对于邮件渠道，存放邮件地址|否
|channel_valid_time|渠道的可用时间|目前暂时不使用。|否
|===

* 消息模板（message_template）

[cols="1,2,4,1" options="header"]
|===
|字段名称|字段中文名称|字段描述|主键
|template_id|模板唯一标识|通知模板的唯一标识。自增。|是
|template_nm|模板名称|通知模板的中文名称。|否
|template_content|模板内容|存放通知内容的模板。模板为字符串文本，可以嵌入格式为“{变量名}”的变量。|否
|===


=== 功能列表

==== 告警规则查询

===== 用户界面交互
. 用户可以使用指标和指标阈值作为条件，查询为该阈值定义的告警规则。
. 告警规则列表的字段包括：
.. 指标名称
.. 指标阈值名称
.. 告警方式
.. 告警渠道（暂时只显示电话号码或邮件地址）。
. 用户可以对列表中的告警规则进行编辑或删除。
. 用户点击列表上方的“新增”按钮可以增加新的告警规则。

===== 后台处理逻辑
. 根据用户指定的指标和指标阈值查询为该阈值定义的告警规则，及该规则所关联的告警渠道信息。

===== 告警规则新增/编辑

===== 用户界面交互
* 输入内容：
. 指标名称
. 指标阈值名称
. 告警方式
. 告警渠道
. 告警级别
. 内容模板
.. 用户可以选择现有模板，或建立新的模板
.. 当建立新模板时，需要让用户输入模板名称和模板内容，新模板的名称不能与现有模板重复。
.. 用户选择现有模板，可以对模板内容做修改，修改后的模板内容需要一起提交到后台。

===== 后台处理逻辑
. 查询用户可见的有效指标列表
. 查询指定指标的指标阈值列表
. 保存/更新告警规则
.. 告警规则存入事件通知规则表（event_notify_rule）
.. 如果用户指定的渠道信息（类型+渠道内容）在渠道表（message_channel）中已经存在，则复用现有的渠道ID，否则自动建立新的渠道ID。
.. 如果用户新建或修改了内容模板，需要将修改后或新建的模板保存到消息模板表（message_template）表中。

===== 告警规则删除

===== 用户界面交互
. 用户在告警规则列表中点击需要删除的告警规则右侧的删除按钮
. 系统提示用户确认删除
. 用户点击确定，则向后台提交删除请求，否则返回列表。

===== 后台处理逻辑
. 从事件通知规则表（event_notify_rule）中删除用户指定的告警规则记录。
