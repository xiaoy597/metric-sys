= 指标管理系统需求分析和总体设计
肖燏 <yu.xiao@seaboxdata.com>
v1.0

== 系统概述
指标管理系统建立在大数据平台所采集和管理的海量数据基础上，帮助用户建立和管理全方位衡量业务发展目标的关键指标体系，是实现企业数据价值的重要工具。

指标管理系统具备以下主要特点：

* 支持指标数据查询分析，支持自定义数据仪表板。
* 支持指标体系维护管理，支持公共指标体系和私有指标体系。
* 支持精细化的指标数据访问权限控制。
* 支持多种指标数据源。
* 支持自由定义的指标维度。
* 支持自定义指标计算公式。
* 支持通过数据接口对外提供指标数据。
* 支持实时和非实时的指标数据管理。


== 系统业务模型

=== 基本概念

* 指标数据源：指标数据源表示基础指标的数据来源。指标数据源可以是关系数据库、本地或远程文件系统、消息队列或NoSQL数据库。*目前仅支持使用关系数据库作为指标数据源。*
* 基础指标：指能够从指标数据源直接查询得到的指标。基础指标的计算不依赖于其他指标。基础指标只存在于公共指标库中。
* 衍生指标：指使用基础指标或其他衍生指标的值，经过用户定义的运算而得到的指标。衍生指标可以存在于公共指标库和私有指标库中。
* 指标目录：是对基础指标和衍生指标进行的多级分类。指标目录中可以包含子目录或者具体指标，但不能两者兼有，指标只能包含在最下层指标目录中。
* 指标体系：指标体系代表从根节点开始的一颗完整的指标目录树及目录下所涵盖的指标。
** 公共指标体系：由专职部门维护管理，对指标管理系统的所有用户可见，公共指标体系中只包含公共指标库中的指标，任何用户都可以根据自己的权限查看或引用公共指标体系中的指标。
** 私有指标体系：由各业务部门自行维护管理，私有指标体系既可以包含公共指标库中的指标，也可以包含本部门私有指标库中的指标，私有指标体系只对本业务部门的用户可见。
* 指标库：用于存放指标数据的数据库，指标库在逻辑上划分为多个区域，分别用于存放公共指标数据和各部门私有指标数据。公共指标区域中的表分为指标主表和指标维表两部分，其中维度表由所有指标区域共享，各部门指标库区域只包含部门私有指标主表。
* 指标维度：指标可以拥有多个维度，如时间周期、管理机构（地区）等。维度可以包含多级粒度。所有指标都至少具备时间周期维度和管理机构（或地区）维度，可以根据需要增加其他维度。衍生指标的维度是它所引用的基础指标或其他衍生指标的公共维度以及粒度的子集。

=== 业务流程

.指标管理系统业务流程
image::business-flow.jpg[]

=== 用户角色
系统设置下列用户角色：

* 普通用户：使用指标管理系统进行指标数据查询和分析的人员。
* 公共指标维护人员：负责维护公共指标体系和公共指标，包括基础指标和衍生指标。
* 部门指标维护人员：负责维护本部门指标体系和私有指标。
* 公共指标管理人员：负责审核对公共指标体系和公共指标的调整，以及对指标接口的审核。
* 部门指标管理人员：负责审核对部门指标体系和私有指标的调整，以及对指标接口的审核。
* 指标系统管理人员：负责指标管理系统的运行维护，包括数据源管理、指标库管理、指标接口管理。
* 指标数据安全管理人员：负责设置指标数据的安全级别和各用户岗位的数据访问权限。

=== 角色职责矩阵
.系统角色职责矩阵
image::role-privileges.jpg[]


== 系统数据模型

参见**指标管理系统.erwin**。

== 系统技术架构

.系统技术架构图
image::sys-architecture.jpg[]


== 指标管理系统Web应用

=== 指标查询分析
// Needs more detailed information ...

==== 指标数据查询浏览
指标数据检索：在选定的指标上设置维度筛选条件，检索指标数据。系统根据用户角色、指标安全级别和用户的组织机构属性对查询结果进行过滤，防止用户对数据的越权访问。

==== 指标数据导入/导出
用户可以选择将查询结果中的指标数据导出到文件中。指标体系的维护人员可以从文件中导入指标数据，如果导入的数据和指标库中的数据有冲突，需要询问用户是否覆盖。指标数据的导入导出操作都需要记录到用户访问日志中。

==== 指标仪表盘
指标仪表盘提供指标的图形化展现和分析功能，用户可以选择需要在仪表盘上展现的指标数据和展现形式（折线图、饼图、柱状图等）。

===== 指标仪表盘基本要素

===== 指标仪表盘功能
* 仪表盘浏览
* 定制仪表盘内容


=== 指标体系管理

公共指标体系维护人员和各业务部门指标体系维护人员可以创建、维护指标体系内容，指标体系（包括各级指标目录及所引用的指标）的修改需要经过审核才能生效。

.指标体系框架
image::metric-hierarchy.jpg[]

==== 指标体系基本要素
* 指标体系名称
* 指标体系代码
* 指标体系根目录名称
* 指标体系根目录代码
* 指标体系部门代码

==== 指标目录基本要素
指标目录的归属部门与上级指标目录归属部门相同，根目录的归属部门为与该根目录对应的指标体系所归属的业务部门。

* 指标目录名称
* 指标目录代码，在指标体系内不得重复。
* 上级指标目录代码
* 指标目录显示顺序
* 指标体系代码
* 最后更新用户
* 最后审核用户
* 最后更新时间
* 最后审核时间

==== 基础指标基本要素
* 指标名称
* 指标代码
* 业务部门代码
* 指标数据源代码
* 指标主表代码
* 指标库度量字段代码
* 指标数据单位
* 指标计算周期
* 指标描述
* 最后更新用户
* 最后审核用户
* 最后更新时间
* 最后审核时间

==== 衍生指标基本要素
* 指标名称
* 指标代码
* 业务部门代码
* 指标计算公式模板
* 指标主表代码
* 指标库度量字段代码
* 指标数据单位
* 指标计算周期
* 指标描述
* 最后更新用户
* 最后审核用户
* 最后更新时间
* 最后审核时间

==== 指标体系管理功能

===== 指标体系浏览
指标体系的浏览采用类似Windows资源管理器的方式，窗口左边为指标分类树，点击分类树底层节点时，在窗口右侧显示该目录下引用的指标列表。

* 指标浏览查询
+
根据指标名称、指标代码、指标所属部门、指标数据源、指标主表检索符合条件的指标配置信息。

* 指标依赖关系视图
+
以有向图的方式展示基础指标和衍生指标之间的依赖关系。

===== 指标体系维护
* 指标体系创建
+
由指标管理部门创建的指标体系为公共指标体系，其他业务部门创建的指标体系为部门私有指标体系。

* 指标体系基本属性维护

* 指标分类目录维护
** 创建、删除目录
+
不允许删除非空的指标目录。
** 在目录下增加、删除指标
+
不允许指标目录既有子目录，又包含指标。
** 修改目录属性
+
不可修改指标目录代码和归属部门。

* 指标维护

** 基础指标配置/修改
. 设置指标基本属性
.. 指标名称
.. 指标代码
.. 指标数据单位
. 设置指标维度和各维度的数据粒度
. 设置指标数据源
.. 选择指标数据源
.. 编写数据筛选语句或上传数据筛选脚本
. 指标主表和度量字段设置
+
系统根据用户设置的指标维度自动选择指标主表并增加主表度量字段。
. 设置指标计算周期
+
支持以下计算周期设置：
+
.. 固定日期（不定期）
.. 固定间隔
.. 固定周期（每年/季/月/周的第几天）
.. CRON表达式

** 衍生指标配置/修改
. 设置指标基本属性
.. 指标名称
.. 指标代码
.. 指标数据单位
. 设置指标维度和各维度的数据粒度
. 设置指标计算公式模板
.. 挑选用于指标计算的基础指标和其他衍生指标
.. 编写指标计算公式
. 指标主表和度量字段设置
+
系统根据用户设置的指标维度自动选择指标主表并增加主表度量字段。
. 设置指标计算周期
+
支持以下计算周期设置：
+
.. 固定日期（不定期）
.. 固定间隔
.. 固定周期（每年/季/月/周的第几天）
.. CRON表达式

** 指标配置删除
+
不可删除被其他衍生指标所引用的基础指标或衍生指标。

** 指标试算
+
验证指标数据源查询或指标计算模板的正确性。

* 指标体系发布
+
指标体系修改后需要通过发布动作启动审核流程，审核通过后才能生效。

===== 指标体系审核
对指标体系及指标定义的修改需经过审核才能生效，审核界面应标注新增、修改、及删除的目录。 公共指标体系的审核由指标管理系统管理部门负责，其他业务部门私有指标体系的审核由本部门负责。

* 浏览指标体系修改内容
+
查看指标体系中新增、修改和删除的指标和指标目录。
* 批准指标体系更新
* 拒绝指标体系更新

=== 数据权限管理

由于数据权限的管理策略同用户的组织架构有密切关系，因此需要定义一个能够适应大部分用户情况的比较通用的组织架构形式，作为实施指标数据权限管理的前提条件。

==== 指标管理系统用户组织架构
用户组织架构包括两个交叉的体系，分别为行政管理体系和业务管辖体系，图中蓝色实线表示行政隶属关系，红色虚线表示业务管辖关系。

.用户组织架构
image::organization-hierarchy.jpg[]

==== 指标数据权限管理框架

用户对指标的访问权限可以从三个维度进行管理：

* 用户的业务部门
+
用户可以浏览和访问的指标（及指标目录）包括所有公共指标体系和用户所在业务部门的私有指标体系。
* 用户所处行政管理机构
+
所有指标数据都具备管理机构（或地区）维度，对于非公开指标，用户只能访问处于他所在管理机构管辖范围内的指标数据。
* 指标数据安全级别
+
所有指标都需要设置安全级别，例如公开、内部、保密、绝密等。用户的角色（或岗位）决定了他能够访问的指标数据的最高安全级别。
可以为同一指标在不同维度和维度级别上的数据设置不同的安全级别。

==== 指标数据权限管理功能

* 用户角色数据权限管理
** 用户角色数据权限浏览
** 用户角色数据权限维护
* 指标数据安全级别管理
** 指标数据安全级别查询浏览
** 指标数据安全级别维护
+
可以为指标的不同维度、不同粒度的数据设置不同的安全级别。

=== 数据接口管理

指标管理系统的指标数据可以通过接口供其他系统使用。接口的数据访问权限与申请开放接口的用户所具备的数据访问权限相同。数据接口的开放和更新需要经过指标体系管理人员的审核。

==== 业务流程

.指标数据接口处理流程
image::interface-workflow.jpg[]

==== 指标数据接口基本要素
* 接口申请用户
* 接口审批用户
* 接口名称
* 接口代码
* 接口对应的指标列表
* 指标数据筛选条件
* 接口访问频次和数据量限制
* 接口有效期限
* 接口访问令牌

==== 指标数据接口管理功能

* 数据接口查询浏览
* 数据接口申请
. 设置接口名称、接口代码
. 选择指标列表
. 设置数据筛选条件
. 设置访问频次和数据量限制
. 设置有效期限

* 数据接口审核
. 浏览数据接口开放或更新申请
. 同意/拒绝接口开放或更新申请
. 生成接口访问令牌

* 数据接口启用/停用


=== 系统管理
==== 系统日志分析
* 指标加载日志分析
** 指标加载日志查询（指定指标代码、时间段、错误级别等条件）
** 日志全文检索
* 指标访问日志分析
** 指标访问日志查询（指定指标代码、时间段、用户、部门等条件）
** 日志全文检索
* 指标维护日志分析
** 指标体系维护日志查询（指定指标代码、时间段、用户、部门等条件）
* 数据接口日志分析
** 数据接口访问日志查询
+
根据给定的接口名称、接口代码、日期区间、接口用户查询接口访问日志明细。
** 数据接口访问统计
+
按照用户指定的分组标准（包括：接口、日期、接口用户、正常/异常，异常类型）对接口访问日志进行分组统计。

==== 用户角色管理
* 用户角色查询浏览
* 用户角色信息维护

==== 数据源管理
对基础指标的数据源进行管理，包括数据源的增加、修改、删除和查询。

===== 数据源的基本属性

* 数据源名称
* 数据源类型，用于区分数据库、文件、及其他结构化数据源。
* 数据源访问参数，表示访问该数据源需要提供的参数，如用户名、口令、地址、端口等。

===== 数据源管理功能
* 数据源浏览
* 数据源新增、修改
* 数据源删除
+
被基础指标引用的数据源不能被删除。

==== 指标库管理

指标库由主表和维表构成。维表定义了指标可以使用的维度，主表用于存放指标数据。

* 指标维表：定义指标维度的表。指标的每个维度（如日期、地域、币种等）都对应到不同的指标维表。维度可以包含多个粒度，维度粒度用维度表的字段表示。维度表和指标主表之间使用维度表的记录ID关联。
* 指标主表：指标主表存储指标数据。指标库中可以有多个指标主表。指标的维度由与指标主表关联的指标维表所定义。存储在同一个指标主表中的所有指标都具备相同的维度。指标主表可以包含多个度量字段，每个度量字段对应一个指标（可以是基础指标或衍生指标）。一个主表中可以存放若干个基础指标和衍生指标的指标数据。指标库的度量字段根据指标的配置动态增加或删除。

.指标库数据模型示意
image::metric-db.jpg[]

===== 指标库基本要素
* 指标库维度列表
** 维度名称
** 维度表名称
** 维度粒度列表
*** 粒度名称
*** 粒度字段名称
*** 粒度等级
*** 粒度字段数据类型
*** 粒度描述
* 指标库主表列表
** 主表名称
** 主表所属部门
** 主表维度列表
*** 维度名称
*** 维度粒度名称
** 主表指标字段列表
*** 指标字段名称
*** 指标字段物理名称
*** 指标字段数据类型
*** 指标字段描述

===== 指标库管理功能
* 指标维度管理
** 指标维度浏览
** 指标维度新建、编辑
*** 维度粒度管理
** 指标维度删除
+
被指标主表引用的指标维度不可删除
* 指标主表管理
+
指标主表在用户维护指标时根据指标的维度自动创建并增加/删除度量字段。

** 指标主表浏览
** 指标主表拆分
+
将数据量过大的指标主表拆分为多个维度相同的主表，可以提高指标查询效率。
** 指标主表删除
+
被指标所引用的指标主表不可删除。
* 指标库模型视图
+
以图形化方式展现指标库中各指标维度和指标主表之间的关系
* 指标数据量分析
+
提供指标主表和指标级别的数据量分析功能。


==== 系统运行报告
+
包含下列基本要素：

* 报告日期区间
* 指标体系维护情况
** 审核通过的各指标体系的新增、修改和删除的指标
* 指标加载情况
** 故障情况分析：故障天数、故障原因分析
** 指标数据量分析：各主表数据量、各主表数据增量
* 指标访问情况
** 用户访问情况：各部门访问指标数据次数排名
** 接口访问情况：指标访问数据量排名、接口账号活跃度排名 

=== 指标批量加载引擎

=== 流式指标加载引擎

=== 指标数据接口
