= 指标管理系统需求分析
肖燏 <yu.xiao@seaboxdata.com>
v1.0

== 系统定位
指标管理系统建立在大数据平台所采集和管理的海量数据基础上，帮助用户建立和管理全方位衡量业务发展目标的关键指标体系，是实现企业数据价值的重要工具。

== 业务流程

.指标管理系统业务流程
image::business-flow.jpg[]

== 基本概念

* 指标数据源：指标数据源表示基础指标的数据来源。指标数据源在逻辑上是一个包含多个维度和指标字段的二维表，可以在物理上以多种形式存在，如从关系数据库中查询得到的结果集、二维表形式的结构化文件（CSV、Excel等）、通过转换从其他形式的数据（如JSON、XML等）得到的二维表结构等。*目前仅支持从关系数据库中查询得到的结果集。*
* 基础指标：指能够从指标数据源直接查询得到的指标。基础指标的计算不依赖于其他指标。基础指标只存在于公共指标库中。
* 衍生指标：指使用基础指标或其他衍生指标的值，经过用户定义的运算而得到的指标。衍生指标可以存在于公共指标库和私有指标库中。
* 指标目录：是对基础指标和衍生指标进行的多级分类。指标目录中可以包含子目录或者具体指标，但不能两者兼有，指标只能包含在最下层指标目录中。
* 指标体系：指标体系代表从根节点开始的一颗完整的指标目录树及目录下所涵盖的指标。
** 公共指标体系：由专职部门维护管理，对指标管理系统的所有用户可见，公共指标体系中只包含公共指标库中的指标，任何用户都可以根据自己的权限查看或引用公共指标体系中的指标。
** 私有指标体系：由各业务部门自行维护管理，私有指标体系既可以包含公共指标库中的指标，也可以包含本部门私有指标库中的指标，私有指标体系只对本业务部门的用户可见。
* 指标库：包括存放指标计算结果的事实表和相关的维表。具备相同维度的指标的数据可以被保存在相同的指标库中。
** 公共指标库：存放公共指标体系中的基础指标和衍生指标的指标库。
** 私有指标库：存放各业务部门所配置的供本部门使用的衍生指标的指标库。
* 指标维度：指标可以拥有多个维度，如时间周期、管理机构（地区）等。维度可以包含多级粒度。所有指标都至少具备时间周期维度和管理机构（或地区）维度，可以根据需要增加其他维度。衍生指标的维度是它所引用的基础指标或其他衍生指标的公共维度以及粒度的子集。

== 数据源管理
对基础指标的数据源进行管理，包括数据源的增加、修改、删除和查询。

=== 数据源的基本属性

* 数据源名称
* 数据源类型，用于区分数据库、文件、及其他结构化数据源。
* 数据源访问参数，表示访问该数据源需要提供的参数，如用户名、口令、地址、端口等。

=== 数据源管理功能
* 数据源浏览
* 数据源新增、修改
* 数据源删除
+
被基础指标引用的数据源不能被删除。

== 指标库管理

指标库定义了指标可以使用的维度，以及指标存放的数据主表。指标的维度必须和指标主表的维度相匹配。一个主表中可以存放若干个基础指标和衍生指标的指标数据。指标库的度量字段根据指标的配置动态增加或删除。

.指标库数据模型示意
image::metric-db.jpg[]

=== 指标库基本要素
* 指标库维度列表
** 维度名称
** 维度表名称
** 维度粒度列表
*** 粒度名称
*** 粒度字段名称
*** 粒度等级
*** 粒度字段数据类型
*** 粒度描述
* 指标库主表列表
** 主表名称
** 主表维度列表
*** 维度名称
*** 维度粒度名称
** 主表指标字段列表
*** 指标字段名称
*** 指标字段物理名称
*** 指标字段数据类型
*** 指标字段描述

=== 指标库管理功能
* 指标维度管理
** 指标维度浏览
** 指标维度新建、编辑
** 指标维度删除
+
被指标主表引用的指标维度不可删除
* 指标主表管理
** 指标主表浏览
** 指标主表新建、编辑
** 指标主表删除
+
被指标所引用的指标主表不可删除。
* 指标库运行管理
** 指标数据量分析
+
提供指标库和指标级别的数据量分析功能。
** 指标日志分析
*** 指标加载日志分析
**** 指标加载日志查询（指定指标代码、时间段、错误级别等条件）
**** 日志全文检索
*** 指标访问日志分析
**** 指标访问日志查询（指定指标代码、时间段、用户、部门等条件）
**** 日志全文检索
*** 指标体系维护日志分析
**** 指标体系维护日志查询（指定指标代码、时间段、用户、部门等条件）
** 指标库运行报告
+
包含下列基本要素：
*** 报告日期区间
*** 指标体系维护情况
***** 审核通过的各指标体系的新增、修改和删除的指标
*** 指标加载情况
**** 故障情况分析：故障天数、故障原因分析
**** 指标数据量分析：各主表数据量、各主表数据增量
*** 指标访问情况
**** 用户访问情况：各部门访问指标数据次数排名
**** 接口访问情况：指标访问数据量排名、接口账号活跃度排名 

== 指标体系管理

公共指标体系管理部门和各业务部门中有权限的用户可以创建、修改指标体系，指标体系（包括各级指标目录及所引用的指标）的修改需要经过审核才能生效。

.指标体系框架
image::metric-hierarchy.jpg[]

=== 指标体系基本要素
* 指标体系名称
* 指标体系代码
* 指标体系根目录名称
* 指标体系根目录代码

=== 指标目录基本要素

* 指标目录名称
* 指标目录代码，在指标体系内不得重复。
* 上级指标目录代码
* 指标目录归属部门
+
指标目录的归属部门与上级指标目录归属部门相同，根目录的归属部门为与该根目录对应的指标体系所归属的业务部门。

=== 基础指标基本要素
* 指标名称
* 指标代码
* 指标数据源
* 指标库名称
* 指标库度量字段名
* 指标数据单位
* 指标计算周期

=== 衍生指标基本要素
* 指标名称
* 指标代码
* 指标所属部门
* 指标数据源
* 指标库名称
* 指标库度量字段名
* 指标数据单位
* 指标计算公式模板
* 指标计算周期

=== 指标体系管理功能

* 指标体系浏览
+
指标体系的浏览采用类似Windows资源管理器的方式，窗口左边为指标分类树，点击分类树底层节点时，在窗口右侧显示该目录下引用的指标列表。
* 指标检索
+
根据指标名称、指标代码、指标所属部门、指标数据源、指标主表检索符合条件的指标定义。

* 维护指标体系
** 创建指标体系
+
由指标管理部门创建的指标体系为公共指标体系，其他业务部门创建的指标体系为部门私有指标体系。
** 维护指标体系基本属性
** 维护指标分类目录
*** 创建、删除目录
+
不允许删除非空的指标目录。
*** 在目录下增加、删除指标
+
不允许指标目录既有子目录，又包含指标。
*** 修改目录属性
+
不可修改指标目录代码和归属部门。

** 指标维护
*** 指标配置信息浏览
*** 指标配置/修改
**** 基础指标配置/修改
. 设置指标基本属性
.. 指标名称
.. 指标代码
.. 指标数据单位
. 设置指标维度和各维度的数据粒度
. 设置指标数据源
.. 选择指标数据源
.. 编写数据筛选语句或上传数据筛选脚本
. 指标库设置
.. 指定主表（主表的维度必须与指标维度相同）
.. 指定主表度量字段
. 设置指标计算周期
**** 衍生指标配置/修改
. 设置指标基本属性
.. 指标名称
.. 指标代码
.. 指标数据单位
. 设置指标维度和各维度的数据粒度
. 设置指标计算公式模板
.. 挑选用于指标计算的基础指标和其他衍生指标
.. 编写指标计算公式
. 指标库设置
.. 指定主表（主表的维度必须与指标维度相同）
.. 指定主表度量字段
. 设置指标计算周期
*** 指标配置删除
+
不可删除被其他衍生指标所引用的基础指标或衍生指标。

** 指标试算
** 指标数据查询
. 指标检索：根据指标名称、指标代码、指标所属部门、指标数据源、指标主表检索符合条件的指标定义。
. 指标数据检索：在选定的指标上设置维度筛选条件，检索指标数据。
* 指标体系发布
+
指标体系修改后需要通过发布动作启动审核流程，审核通过后才能生效。

* 指标体系审核
+
对指标体系及指标定义的修改需经过审核才能生效，审核界面应标注新增、修改、及删除的目录。
** 指标体系审核权限
+
公共指标体系的审核由指标管理系统管理部门负责，其他业务部门私有指标体系的审核由本部门负责。
** 指标体系审核功能
*** 浏览指标体系修改内容
+
查看指标体系中新增、修改和删除的指标和指标目录。
*** 批准指标体系更新
*** 拒绝指标体系更新

== 指标数据权限管理

由于数据权限的管理策略同用户的组织架构有密切关系，因此需要定义一个能够适应大部分用户情况的比较通用的组织架构形式，作为实施指标数据权限管理的前提条件。

=== 指标管理系统用户组织架构
用户组织架构包括两个交叉的体系，分别为行政管理体系和业务管辖体系，图中蓝色实线表示行政隶属关系，红色虚线表示业务管辖关系。

.用户组织架构
image::organization-hierarchy.jpg[]

=== 指标数据权限管理框架

用户对指标的访问权限可以从三个维度进行管理：

* 用户的业务部门
+
用户可以浏览和访问的指标（及指标目录）包括所有公共指标体系和用户所在业务部门的私有指标体系。
* 用户所处行政管理机构
+
所有指标数据都具备管理机构（或地区）维度，对于非公开指标，用户只能访问处于他所在管理机构管辖范围内的指标数据。
* 指标数据安全级别
+
所有指标都需要设置安全级别，例如公开、内部、保密、绝密等。用户的角色（或岗位）决定了他能够访问的指标数据的最高安全级别。
可以为同一指标在不同维度和维度级别上的数据设置不同的安全级别。

=== 指标数据权限管理功能

* 设置用户角色的指标访问安全级别。
* 设置指标数据（包括各维度和粒度）的数据安全级别。

== 指标数据接口管理

指标管理系统的指标数据可以通过接口供其他系统使用。接口的数据访问权限与申请开放接口的用户所具备的数据访问权限相同。

=== 业务流程

.指标数据接口业务流程
image::interface-workflow.jpg[]

=== 指标数据接口基本要素
* 接口申请用户
* 接口审批用户
* 接口名称
* 接口代码
* 接口对应的指标列表
* 指标数据筛选条件
* 接口访问频次和数据量限制
* 接口有效期限
* 接口访问令牌

=== 指标数据接口管理功能

* 数据接口查询浏览
* 数据接口关闭
* 数据接口开放/更新申请
. 设置接口名称、接口代码
. 选择指标列表
. 设置数据筛选条件
. 设置访问频次和数据量限制
. 设置有效期限

* 数据接口开放/更新审核
. 浏览数据接口开放申请
. 同意/拒绝接口开放申请
. 生成接口访问令牌

* 数据接口运行分析
** 数据接口访问日志查询
+
根据给定的接口名称、接口代码、日期区间、接口用户查询接口访问日志明细。
** 数据接口访问统计
+
按照用户指定的分组标准（包括：接口、日期、接口用户、正常/异常，异常类型）对接口访问日志进行分组统计。
